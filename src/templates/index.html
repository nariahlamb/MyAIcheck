<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyAIcheck - AI接口密钥验证工具</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🔑</text></svg>" type="image/svg+xml">
    <style>
        :root {
            --primary-color: #D88CA0; /* 降低饱和度的粉色 */
            --primary-light: #E8B0BD; /* 更柔和的浅粉色 */
            --primary-dark: #B56B80; /* 更柔和的深粉色 */
            --secondary-color: #9D79AC; /* 更柔和的紫色辅助色 */
            --accent-color: #74A4CD; /* 更柔和的蓝色强调色 */
            --success-color: #7BAE80; /* 更柔和的绿色 */
            --error-color: #D77A77; /* 更柔和的红色 */
            --warning-color: #E0B883; /* 更柔和的黄色 */
            --bg-color: #F6E9EE; /* 更浅的背景色 */
            --bg-gradient: linear-gradient(135deg, #F6E9EE 0%, #F0DCE4 100%); /* 更柔和的渐变背景 */
            --card-bg: #FFF5F8; /* 微浅粉色卡片背景，不再是纯白色 */
            --text-color: #5B5B5B; /* 更柔和的文本颜色 */
            --text-light: #8A8A8A; /* 更柔和的浅色文本 */
            --border-color: #E8D0D8; /* 更柔和的边框颜色 */
            --border-radius: 12px; /* 圆角半径 */
            --box-shadow: 0 4px 20px rgba(216, 140, 160, 0.08); /* 更柔和的阴影效果 */
            --font-family: 'Helvetica Neue', Arial, sans-serif;
            --transition: all 0.3s ease;
        }
        
        /* 暗色模式变量 */
        .dark-mode {
            --primary-color: #88C0D0; /* Nord蓝色调 */
            --primary-light: #8FBCBB; /* Nord浅蓝 */
            --primary-dark: #5E81AC; /* Nord深蓝 */
            --secondary-color: #B48EAD; /* Nord紫色 */
            --accent-color: #81A1C1; /* Nord亮蓝 */
            --success-color: #A3BE8C; /* Nord绿色 */
            --error-color: #BF616A; /* Nord红色 */
            --warning-color: #EBCB8B; /* Nord黄色 */
            --bg-color: #2E3440; /* Nord最深背景 */
            --bg-gradient: linear-gradient(135deg, #2E3440 0%, #3B4252 100%); /* Nord渐变背景 */
            --card-bg: #3B4252; /* Nord次深背景 */
            --text-color: #ECEFF4; /* Nord雪白 */
            --text-light: #E5E9F0; /* Nord浅雪白 */
            --border-color: #4C566A; /* Nord浅灰色 */
            --box-shadow: 0 4px 20px rgba(46, 52, 64, 0.5); /* 阴影效果 */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            line-height: 1.5; /* 减小行高 */
            color: var(--text-color);
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 10px 0; /* 进一步减小上下内边距 */
        }
        
        .container {
            max-width: 1400px; /* 增加宽度 */
            margin: 0 auto;
            padding: 0 10px; /* 减小左右内边距 */
        }
        
        header {
            text-align: center;
            margin-bottom: 1rem; /* 减小下边距 */
            animation: fadeIn 1s ease;
        }
        
        h1 {
            font-size: 2.2rem; /* 减小字体大小 */
            margin-bottom: 0.5rem; /* 减小下边距 */
            color: var(--primary-dark);
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        .description {
            color: var(--text-light);
            margin-bottom: 0.8rem; /* 减小下边距 */
            font-size: 1rem; /* 减小字体大小 */
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px; /* 减小内边距 */
            margin-bottom: 1rem; /* 减小下边距 */
            animation: slideUp 0.5s ease;
            border: 1px solid var(--border-color);
        }
        
        .api-type-selector {
            display: flex;
            flex-wrap: nowrap; /* 确保在一行显示 */
            gap: 8px; /* 减小间距 */
            margin-bottom: 15px;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--card-bg);
            padding: 15px 0 5px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .api-type-btn {
            padding: 10px 15px; /* 减小内边距 */
            border: 2px solid var(--primary-light);
            background-color: white;
            color: var(--primary-dark);
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.95rem; /* 减小字体大小 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            white-space: nowrap; /* 防止文本换行 */
        }
        
        .api-type-btn::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            pointer-events: none;
        }
        
        .api-type-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(240, 98, 146, 0.2);
        }
        
        .api-type-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(240, 98, 146, 0.3);
        }
        
        .api-settings {
            margin: 15px 0; /* 减小上下边距 */
            padding: 12px; /* 减小内边距 */
            border-radius: 10px;
            background-color: #F0E3E9; /* 更柔和的背景色 */
            border: 1px dashed var(--primary-light);
            animation: fadeIn 0.5s ease;
        }
        
        .custom-settings {
            display: none;
            background-color: #EEE5F0; /* 更柔和的背景色 */
            border-color: #D4BCD9; /* 更柔和的边框色 */
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .model-select-container {
            margin-top: 10px; /* 减小上边距 */
        }
        
        .model-select {
            width: 100%;
            padding: 10px; /* 减小内边距 */
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem; /* 减小字体大小 */
            color: var(--text-color);
            transition: var(--transition);
            background-color: white;
            margin-top: 5px; /* 减小上边距 */
        }
        
        .model-select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(240, 98, 146, 0.2);
        }
        
        .input-group {
            margin-bottom: 1rem; /* 减小下边距 */
        }
        
        .custom-input {
            width: 100%;
            padding: 10px; /* 减小内边距 */
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-color);
            transition: var(--transition);
            background-color: white;
        }
        
        .custom-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(240, 98, 146, 0.2);
        }
        
        .custom-input::placeholder {
            color: #bdbdbd;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px; /* 减小下边距 */
            background-color: #F0E3E9; /* 更柔和的背景色 */
            padding: 10px 15px;
            border-radius: 8px;
        }
        
        .toggle-label {
            margin-right: 15px;
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f8bbd0;
            transition: var(--transition);
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .help-text {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-left: 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            transition: var(--transition);
            color: var(--text-light);
            position: relative;
        }
        
        .tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 3px;
            background-color: var(--primary-color);
            transition: var(--transition);
        }
        
        .tab.active {
            color: var(--primary-color);
        }
        
        .tab.active::after {
            width: 100%;
        }
        
        .tab:hover:not(.active) {
            color: var(--primary-dark);
        }
        
        textarea {
            width: 100%;
            min-height: 100px; /* 减小文本框高度 */
            padding: 10px; /* 减小内边距 */
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem; /* 减小字体大小 */
            resize: vertical;
            transition: var(--transition);
        }
        
        textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(240, 98, 146, 0.2);
        }
        
        .file-input-container {
            position: relative;
            margin-top: 10px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 20px;
            background-color: #f8bbd0;
            color: var(--primary-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .file-input-label:hover {
            background-color: var(--primary-light);
        }
        
        .file-input-label i {
            margin-right: 8px;
        }
        
        .file-input {
            position: absolute;
            left: -9999px;
        }
        
        .file-name {
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .actions-container {
            display: flex;
            gap: 8px; /* 减小按钮间隔 */
            margin-top: 1rem; /* 减小上边距 */
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px; /* 减小内边距 */
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.95rem; /* 减小字体大小 */
            font-weight: 500;
            text-align: center;
            transition: var(--transition);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            pointer-events: none;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(240, 98, 146, 0.3);
        }
        
        .btn-secondary {
            background-color: #f8bbd0;
            color: var(--primary-dark);
        }
        
        .btn-secondary:hover {
            background-color: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(240, 98, 146, 0.2);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #43a047;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 187, 106, 0.3);
        }
        
        .btn-pause {
            background-color: var(--warning-color);
            color: #5d4037;
        }
        
        .btn-pause:hover {
            background-color: #ffb300;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }
        
        .progress {
            margin-top: 1rem; /* 减小上边距 */
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--primary-dark);
            font-weight: 500;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 12px;
            background-color: #f8bbd0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
            transition: width 0.3s ease;
            width: 0%;
            border-radius: 6px;
        }
        
        .dark-mode .progress-bar-container {
            background-color: #4C566A;
        }
        
        .dark-mode .progress-bar {
            background: linear-gradient(90deg, #81A1C1, #5E81AC);
        }
        
        .dark-mode .progress-info,
        .dark-mode .progress-stats {
            color: #E5E9F0;
        }
        
        .progress-stats {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .progress-control {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .results-container {
            margin-top: 0;
            display: block; /* 默认显示 */
            animation: fadeIn 0.5s ease;
            height: 100%;
            overflow-y: auto;
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            flex: 1;
        }
        
        /* 结果表为空时显示提示信息 */
        .results-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-light);
            font-style: italic;
        }
        
        .results-heading {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-summary {
            padding: 0 15px;
        }
        
        .results-table-container {
            padding: 0 15px 15px;
            overflow-x: auto;
        }
        
        .results-heading h2 {
            color: var(--primary-dark);
            font-size: 1.6rem;
            margin: 0;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }
        
        .results-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .summary-item {
            flex: 1;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.07);
            transition: var(--transition);
        }
        
        .summary-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .summary-total {
            background-color: #E3EEF6; /* 更柔和的蓝色 */
            border: 1px solid #C5DFF0; /* 更柔和的边框 */
        }
        
        .summary-valid {
            background-color: #E4F1E5; /* 更柔和的绿色 */
            border: 1px solid #C9E6CA; /* 更柔和的边框 */
            color: var(--success-color);
        }
        
        .summary-invalid {
            background-color: #F2E5E5; /* 更柔和的红色 */
            border: 1px solid #EACBCB; /* 更柔和的边框 */
            color: var(--error-color);
        }
        
        .summary-item h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .summary-item p {
            font-size: 2.5rem;
            margin: 15px 0 0;
            font-weight: 600;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            table-layout: fixed; /* 为宽屏优化表格布局 */
        }
        
        .results-table th, .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f8bbd0;
        }
        
        .results-table th {
            background-color: #F0E3E9; /* 更柔和的表头背景 */
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        .results-table tr:nth-child(even) {
            background-color: #FAF2F5; /* 更柔和的斑马纹 */
        }
        
        .results-table tr:hover {
            background-color: #F0E3E9; /* 更柔和的hover背景 */
        }
        
        .results-table th:nth-child(1),
        .results-table td:nth-child(1) {
            width: 30%; /* 密钥列宽度 */
            word-break: break-all;
        }
        
        .results-table th:nth-child(2),
        .results-table td:nth-child(2) {
            width: 15%; /* 状态列宽度 */
        }
        
        .results-table th:nth-child(3),
        .results-table td:nth-child(3) {
            width: 55%; /* 错误信息列宽度 */
            word-break: break-word;
        }
        
        .valid-key {
            color: var(--success-color);
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .valid-key::before {
            content: '✓';
            margin-right: 5px;
        }
        
        .invalid-key {
            color: var(--error-color);
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .invalid-key::before {
            content: '✗';
            margin-right: 5px;
        }
        
        .network-error {
            color: var(--warning-color);
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .network-error::before {
            content: '!';
            margin-right: 5px;
        }
        
        /* 宽屏适配的两列布局 */
        @media (min-width: 1200px) {
            .two-column-layout {
                display: flex;
                gap: 20px; /* 减小两列间隔 */
                align-items: stretch; /* 确保等高 */
                height: calc(100vh - 150px); /* 减去头部和边距 */
                min-height: 500px; /* 设置最小高度 */
            }
            
            .input-column, .results-column {
                flex: 1; /* 均等分配空间 */
                display: flex;
                flex-direction: column;
                justify-content: space-between; /* 确保内容分布均匀 */
            }
            
            .card, .results-container {
                flex: 1; /* 占满可用空间 */
                overflow-y: auto; /* 允许内容滚动 */
                display: flex;
                flex-direction: column;
                margin-bottom: 0; /* 移除底部边距 */
            }
            
            /* 添加底部自动对齐 */
            .input-column > .card, .results-column > .results-container {
                min-height: 100%; /* 确保内容区域至少占据整个高度 */
                height: 100%; /* 固定高度 */
                overflow-y: auto; /* 允许内容滚动 */
            }
            
            .results-container {
                margin-top: 0;
                padding: 0; /* 移除内边距，由内部元素控制 */
            }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        @keyframes slideUp {
            0% { 
                opacity: 0; 
                transform: translateY(20px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .results-summary {
                flex-direction: column;
                gap: 15px;
            }
            
            .api-type-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .actions-container {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .results-heading {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .export-buttons {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        .results-table tr:hover {
            background-color: #F0E3E9; /* 更柔和的hover背景 */
        }
        
        .dark-mode .results-table th {
            background-color: #434C5E;
            color: #ECEFF4;
        }
        
        .dark-mode .results-table {
            border-color: #4C566A;
        }
        
        .dark-mode .results-table td {
            border-bottom-color: #4C566A;
        }
        
        .dark-mode .results-table tr:nth-child(even) {
            background-color: #3B4252;
        }
        
        .dark-mode .results-table tr:hover {
            background-color: #4C566A;
        }
        
        /* 暗色模式下的按钮样式优化 */
        .dark-mode .btn-primary {
            background-color: #5E81AC;
            color: #ECEFF4;
        }
        
        .dark-mode .btn-primary:hover {
            background-color: #81A1C1;
        }
        
        .dark-mode .btn-secondary {
            background-color: #4C566A;
            color: #E5E9F0;
        }
        
        .dark-mode .btn-secondary:hover {
            background-color: #5E81AC;
        }
        
        .dark-mode .btn-success {
            background-color: #A3BE8C;
            color: #2E3440;
        }
        
        .dark-mode .btn-success:hover {
            background-color: #8FBCBB;
        }
        
        .dark-mode .btn-pause {
            background-color: #EBCB8B;
            color: #2E3440;
        }
        
        .dark-mode .btn-pause:hover {
            background-color: #D08770;
        }
        
        .dark-mode .api-type-btn {
            border-color: #4C566A;
            background-color: #3B4252;
            color: #E5E9F0;
        }
        
        .dark-mode .api-type-btn.active {
            background-color: #5E81AC;
            color: #ECEFF4;
            border-color: #5E81AC;
        }
        
        .dark-mode .api-type-btn:hover {
            box-shadow: 0 5px 15px rgba(136, 192, 208, 0.3);
        }
        
        .results-table th:nth-child(1),
        .results-table td:nth-child(1) {
            width: 30%; /* 密钥列宽度 */
            word-break: break-all;
        }
        
        /* 主题切换按钮样式 */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: var(--bg-color); /* 使用背景色 */
            border-radius: 50%;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }
        
        .theme-toggle:hover {
            transform: translateY(-2px) rotate(15deg);
            box-shadow: 0 6px 15px rgba(236, 64, 122, 0.2);
            background-color: var(--primary-light);
        }
        
        .theme-toggle-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        /* 节点信息按钮样式 */
        .node-toggle {
            position: fixed;
            top: 20px;
            right: 70px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: var(--bg-color); /* 使用背景色 */
            border-radius: 50%;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }
        
        .node-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(236, 64, 122, 0.2);
            background-color: var(--primary-light);
        }
        
        .node-toggle-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        /* 节点信息区域样式 */
        .node-info {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 300px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
            z-index: 1000;
            border: 1px solid var(--border-color);
            max-height: 500px;
            overflow-y: auto;
            display: none;
        }
        
        .node-info.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .node-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .node-info-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0;
        }
        
        .node-info-refresh {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-light);
            color: var(--card-bg);
            cursor: pointer;
            border: none;
            font-size: 1.2rem;
            transition: var(--transition);
        }
        
        .node-info-refresh:hover {
            transform: rotate(180deg);
            background-color: var(--primary-color);
        }
        
        .node-info-item {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .node-info-label {
            font-weight: 500;
            color: var(--primary-color);
            margin-right: 5px;
        }
        
        .node-info-value {
            color: var(--text-color);
            word-break: break-all;
        }
        
        .node-info-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            color: var(--text-light);
        }
        
        /* 按钮标志 */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: #5d4037;
        }
        
        .badge-info {
            background-color: var(--accent-color);
            color: white;
        }
        
        /* 暗色模式下的文本输入和选择框样式 */
        .dark-mode .custom-input,
        .dark-mode .model-select,
        .dark-mode textarea {
            background-color: #434C5E;
            color: #E5E9F0;
            border-color: #4C566A;
        }
        
        .dark-mode .custom-input::placeholder,
        .dark-mode textarea::placeholder {
            color: #D8DEE9;
        }
        
        .dark-mode .toggle-label,
        .dark-mode .input-group label,
        .dark-mode .tab,
        .dark-mode .toggle-container {
            color: #E5E9F0;
        }
        
        .dark-mode .toggle-container {
            background-color: #3B4252;
        }
        
        .dark-mode .tab.active {
            color: #88C0D0;
        }
        
        .dark-mode .tab::after {
            background-color: #88C0D0;
        }
        
        .dark-mode .api-settings {
            background-color: #3B4252;
            border-color: #4C566A;
        }
        
        .dark-mode .custom-settings {
            background-color: #2E3440;
            border-color: #4C566A;
        }
        
        .dark-mode .file-input-label {
            background-color: #4C566A;
            color: #E5E9F0;
        }
        
        .dark-mode .file-input-label:hover {
            background-color: #5E81AC;
        }
        
        .dark-mode .file-name {
            color: #D8DEE9;
        }
        
        /* 暗色模式下的节点信息样式 */
        .dark-mode .node-info {
            background-color: #3B4252;
            border-color: #4C566A;
        }
        
        .dark-mode .node-info-title {
            color: #88C0D0;
        }
        
        .dark-mode .node-info-refresh {
            background-color: #5E81AC;
            color: #ECEFF4;
        }
        
        .dark-mode .node-info-refresh:hover {
            background-color: #81A1C1;
        }
        
        .dark-mode .node-info-label {
            color: #88C0D0;
        }
        
        .dark-mode .node-info-value {
            color: #E5E9F0;
        }
        
        .dark-mode .node-toggle-icon,
        .dark-mode .theme-toggle-icon {
            color: #88C0D0;
        }
        
        .dark-mode .node-toggle,
        .dark-mode .theme-toggle {
            background-color: #3B4252;
            border-color: #4C566A;
        }
        
        .results-heading {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-heading h2 {
            margin: 0;
            font-size: 1.4rem;
            color: var(--primary-dark);
        }
        
        /* 结果表为空时的提示样式 */
        .results-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-light);
            font-style: italic;
            border-top: 1px solid var(--border-color);
            margin-top: 15px;
        }
        
        /* 批量大小设置 */
        .batch-size-container {
            margin: 15px 0;
            padding: 10px 15px;
            background-color: #F0E3E9; /* 更柔和的背景色 */
            border-radius: 8px;
            border: 1px dashed var(--primary-light);
            animation: fadeIn 0.5s ease;
        }
        
        .dark-mode .batch-size-container {
            background-color: #3B4252;
            border-color: #4C566A;
        }
        
        .batch-size-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .batch-size-label {
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        .dark-mode .batch-size-label {
            color: #88C0D0;
        }
        
        .batch-size-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .batch-size-input {
            width: 50px;
            padding: 5px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.9rem;
            color: var(--text-color);
            transition: var(--transition);
        }
        
        .dark-mode .batch-size-input {
            background-color: #434C5E;
            color: #E5E9F0;
            border-color: #4C566A;
        }
        
        .batch-size-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(240, 98, 146, 0.2);
        }
        
        .batch-size-slider {
            flex: 1;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, var(--primary-light), var(--primary-dark));
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .batch-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .batch-size-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .dark-mode .batch-size-slider {
            background: linear-gradient(to right, #4C566A, #5E81AC);
        }
        
        .dark-mode .batch-size-slider::-webkit-slider-thumb {
            background: #88C0D0;
            border-color: #2E3440;
        }
        
        .dark-mode .batch-size-slider::-moz-range-thumb {
            background: #88C0D0;
            border-color: #2E3440;
        }
        
        .batch-size-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        .dark-mode .batch-size-marks {
            color: #D8DEE9;
        }
        
        /* 夜间模式下的结果摘要样式 */
        .dark-mode .summary-total {
            background-color: #3B4252;
            border-color: #4C566A;
            color: #E5E9F0;
        }
        
        .dark-mode .summary-valid {
            background-color: #3B4252;
            border-color: #4C566A;
            color: #A3BE8C;
        }
        
        .dark-mode .summary-invalid {
            background-color: #3B4252;
            border-color: #4C566A;
            color: #BF616A;
        }
        
        .dark-mode .summary-item h3 {
            color: #88C0D0;
        }
        
        .dark-mode .summary-item p {
            color: #ECEFF4;
        }
        
        /* 并发验证设置 */
        .concurrency-container {
            margin: 15px 0;
            padding: 10px 15px;
            background-color: #F0E3E9; /* 更柔和的背景色 */
            border-radius: 8px;
            border: 1px dashed var(--primary-light);
            animation: fadeIn 0.5s ease;
        }
        
        .dark-mode .concurrency-container {
            background-color: #3B4252;
            border-color: #4C566A;
        }
        
        .concurrency-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .concurrency-label {
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        .dark-mode .concurrency-label {
            color: #88C0D0;
        }
        
        .concurrency-info {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .dark-mode .concurrency-info {
            background-color: #5E81AC;
        }
        
        .concurrency-toggle {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 28px;
        }
        
        .concurrency-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .concurrency-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f8bbd0;
            transition: var(--transition);
            border-radius: 34px;
        }
        
        .concurrency-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }
        
        .concurrency-toggle input:checked + .concurrency-slider {
            background-color: var(--primary-color);
        }
        
        .concurrency-toggle input:checked + .concurrency-slider:before {
            transform: translateX(26px);
        }
        
        .concurrency-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .concurrency-value-label {
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        .dark-mode .concurrency-value-label {
            color: #88C0D0;
        }
        
        .concurrency-input {
            width: 50px;
            padding: 5px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.9rem;
            color: var(--text-color);
            transition: var(--transition);
        }
        
        .dark-mode .concurrency-input {
            background-color: #434C5E;
            color: #E5E9F0;
        }
        
        .concurrency-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(240, 98, 146, 0.2);
        }
        
        .concurrency-input::placeholder {
            color: #bdbdbd;
        }
        
        .concurrency-help-text {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .batch-size-info {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .dark-mode .batch-size-info {
            background-color: #5E81AC;
        }
        
        /* 自定义滚动条样式 */
        /* Webkit浏览器 (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            background-color: transparent;
        }
        
        ::-webkit-scrollbar-track {
            background-color: transparent;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background-color: rgba(240, 98, 146, 0.3);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(240, 98, 146, 0.5);
        }
        
        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(240, 98, 146, 0.3) transparent;
        }
        
        /* 暗色模式滚动条 */
        .dark-mode::-webkit-scrollbar-thumb {
            background-color: rgba(136, 192, 208, 0.3);
        }
        
        .dark-mode::-webkit-scrollbar-thumb:hover {
            background-color: rgba(136, 192, 208, 0.5);
        }
        
        .dark-mode * {
            scrollbar-color: rgba(136, 192, 208, 0.3) transparent;
        }
        
        /* 设置面板样式 */
        .settings-panel {
            margin: 15px 0;
            border-radius: 10px;
            background-color: var(--card-bg);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: #F0E3E9;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 8px;
        }
        
        .dark-mode .settings-header {
            background-color: #3B4252;
        }
        
        .settings-header:hover {
            background-color: #E8D0D8;
        }
        
        .dark-mode .settings-header:hover {
            background-color: #4C566A;
        }
        
        .settings-title {
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        .dark-mode .settings-title {
            color: #88C0D0;
        }
        
        .settings-arrow {
            transition: transform 0.3s ease;
        }
        
        .settings-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .settings-content.expanded {
            padding: 15px;
            max-height: 300px;  /* 限制最大高度 */
            overflow-y: auto;   /* 添加垂直滚动条 */
        }
        
        .settings-section {
            margin-bottom: 15px;
        }
        
        .settings-section:last-child {
            margin-bottom: 0;
        }
        
        .settings-info-btn {
            padding: 5px 15px;
            background-color: var(--primary-light);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .settings-info-btn:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .settings-help {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MyAIcheck</h1>
            <p class="description">一站式AI接口密钥验证工具 | 支持OpenAI、Claude、Gemini等多平台</p>
        </header>
        
        <!-- 暗色模式切换按钮 -->
        <div class="theme-toggle" id="theme-toggle">
            <span class="theme-toggle-icon">🌙</span>
        </div>
        
        <!-- 节点信息按钮 -->
        <div class="node-toggle" id="node-toggle">
            <span class="node-toggle-icon">📶</span>
        </div>
        
        <!-- 节点信息区域 -->
        <div class="node-info" id="node-info">
            <div class="node-info-header">
                <h3 class="node-info-title">节点信息</h3>
                <button class="node-info-refresh" id="refresh-node-info">
                    ↻
                </button>
            </div>
            <div id="node-info-content">
                <div class="node-info-loading">正在获取节点信息...</div>
            </div>
        </div>
        
        <div class="two-column-layout">
            <div class="input-column">
                <div class="card">
                    <div class="api-type-selector">
                        <button class="api-type-btn active" data-api-type="openai">OpenAI</button>
                        <button class="api-type-btn" data-api-type="claude">Claude</button>
                        <button class="api-type-btn" data-api-type="gemini">Gemini</button>
                        <button class="api-type-btn" data-api-type="deepseek">Deepseek</button>
                        <button class="api-type-btn" data-api-type="xai">XAI (Grok)</button>
                        <button class="api-type-btn" data-api-type="openai_like">通用API</button>
                    </div>
                    
                    <!-- 设置菜单折叠面板 -->
                    <div class="settings-panel">
                        <div class="settings-header" id="settings-toggle">
                            <span class="settings-title">验证设置</span>
                            <span class="settings-arrow">▼</span>
                        </div>
                        
                        <div class="settings-content" id="settings-content">
                            <!-- 验证方式设置 -->
                            <div class="settings-section">
                                <div class="toggle-container">
                                    <span class="toggle-label">使用浏览器端验证:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="client-side-toggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="toggle-container auto-detect-container">
                                    <span class="toggle-label">自动检测可用模型:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="auto-detect-toggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- 并发设置 -->
                            <div class="settings-section">
                                <div class="concurrency-container">
                                    <div class="concurrency-header">
                                        <span class="concurrency-label">并发验证:</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="concurrency-toggle" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    <div class="concurrency-controls" id="concurrency-controls">
                                        <span class="concurrency-value-label">并发数量:</span>
                                        <input 
                                            type="number" 
                                            id="concurrency-input" 
                                            min="1" 
                                            max="10" 
                                            value="3" 
                                            class="concurrency-input"
                                        >
                                    </div>
                                </div>
                                
                                <div class="batch-size-container">
                                    <div class="batch-size-header">
                                        <span class="batch-size-label">每批验证数量:</span>
                                    </div>
                                    <div class="batch-size-controls">
                                        <input 
                                            type="range" 
                                            id="batch-size-slider" 
                                            min="1" 
                                            max="50" 
                                            value="10" 
                                            class="batch-size-slider"
                                        >
                                        <input 
                                            type="number" 
                                            id="batch-size-input" 
                                            min="1" 
                                            max="50" 
                                            value="10" 
                                            class="batch-size-input"
                                        >
                                    </div>
                                    <div class="batch-size-marks">
                                        <span>慢(1)</span>
                                        <span>平衡(10)</span>
                                        <span>快(50)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 设置说明 -->
                            <div class="settings-help">
                                <button class="settings-info-btn" id="settings-info-btn">ⓘ 参数说明</button>
                                <span class="help-text">设置将自动保存</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="text-input">文本输入</div>
                        <div class="tab" data-tab="file-input">文件输入</div>
                    </div>
                    
                    <div class="input-group" id="text-input-container">
                        <label for="keys-input">API 密钥 (每行一个):</label>
                        <textarea id="keys-input" placeholder="在此输入您的API密钥，每行一个..."></textarea>
                    </div>
                    
                    <div class="input-group" id="file-input-container" style="display: none;">
                        <label for="file-input">上传 CSV 或文本文件:</label>
                        <div class="file-input-container">
                            <label for="file-input" class="file-input-label">
                                选择文件
                            </label>
                            <input type="file" id="file-input" class="file-input" accept=".csv,.txt">
                            <div class="file-name" id="file-name">未选择文件</div>
                        </div>
                        <p class="help-text">文件第一列应包含API密钥</p>
                    </div>
                    
                    <div class="actions-container">
                        <button id="validate-btn" class="btn btn-primary">验证密钥</button>
                        <button id="clear-btn" class="btn btn-secondary">清除</button>
                    </div>
                    
                    <div class="progress" id="progress-container">
                        <div class="progress-info">
                            <span id="progress-text">验证中...</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        <div class="progress-stats">
                            <span id="validated-count">已验证: 0/0</span>
                            <span id="valid-progress">有效: 0</span>
                            <span id="invalid-progress">无效: 0</span>
                            <span id="error-progress">错误: 0</span>
                            <span id="time-remaining">预计剩余时间: 计算中...</span>
                        </div>
                        <div class="progress-control">
                            <button id="pause-btn" class="btn btn-pause">暂停</button>
                            <button id="cancel-btn" class="btn btn-secondary">取消</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="results-column">
                <div class="results-container" id="results-container">
                    <div class="results-heading">
                        <h2>验证结果</h2>
                        <div class="export-buttons">
                            <button id="export-valid-results-btn" class="btn btn-success">导出有效密钥</button>
                            <button id="export-all-results-btn" class="btn btn-secondary">导出所有结果</button>
                        </div>
                    </div>
                    
                    <div class="results-summary">
                        <div class="summary-item summary-total">
                            <h3>总计</h3>
                            <p id="total-count">0</p>
                        </div>
                        <div class="summary-item summary-valid">
                            <h3>有效</h3>
                            <p id="valid-count">0</p>
                        </div>
                        <div class="summary-item summary-invalid">
                            <h3>无效</h3>
                            <p id="invalid-count">0</p>
                        </div>
                    </div>
                    
                    <div class="results-table-container">
                        <table class="results-table" id="results-table">
                            <thead>
                                <tr>
                                    <th>密钥</th>
                                    <th>状态</th>
                                    <th>错误信息</th>
                                </tr>
                            </thead>
                            <tbody id="results-body">
                                <!-- 结果会被动态添加到这里 -->
                            </tbody>
                        </table>
                        <div class="results-empty" id="results-empty">
                            暂无验证结果，请在左侧输入API密钥并点击"验证密钥"按钮
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 全局变量
        let currentApiType = 'openai';
        let validationResults = [];
        let isClientSideValidation = true;
        let isValidating = false;
        let isPaused = false;
        let validationQueue = [];
        let currentBatchIndex = 0;
        let validationStats = {
            valid: 0,
            invalid: 0,
            error: 0
        };
        let startTime = null;
        let validationController = null; // AbortController用于取消验证
        let isDarkMode = false; // 暗色模式状态
        let nodeInfoVisible = false; // 节点信息显示状态
        let batchSize = 10; // 批量大小，现在可自定义
        let concurrencyEnabled = true; // 是否启用并发验证
        let concurrencyCount = 3; // 并发数量
        let activeBatches = 0; // 当前活跃的批次数量
        let pendingQueue = []; // 等待处理的并发队列
        let autoDetectModels = true; // 是否自动检测模型
        let availableModels = {}; // 每种API类型的可用模型列表
        let modelDetectionInProgress = false; // 模型检测是否正在进行中
        
        // API验证端点配置
        const API_ENDPOINTS = {
            openai: {
                models: 'https://api.openai.com/v1/models',
                completions: 'https://api.openai.com/v1/chat/completions',
                payload: function(model) {
                    return {
                        model: model || 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: 'Hello' }],
                        max_tokens: 1
                    };
                }
            },
            claude: {
                models: 'https://api.anthropic.com/v1/models',
                completions: 'https://api.anthropic.com/v1/messages',
                payload: function(model) {
                    return {
                        model: model || 'claude-3-5-sonnet',
                        max_tokens: 1,
                        messages: [{ role: 'user', content: 'Hello' }]
                    };
                }
            },
            gemini: {
                models: 'https://generativelanguage.googleapis.com/v1beta/models',
                completions: 'https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent',
                payload: function() {
                    return {
                        contents: [{ parts: [{ text: 'Hello' }] }]
                    };
                }
            },
            deepseek: {
                models: 'https://api.deepseek.com/v1/models',
                completions: 'https://api.deepseek.com/v1/chat/completions',
                payload: function(model) {
                    return {
                        model: model || 'deepseek-chat',
                        messages: [{ role: 'user', content: 'Hello' }],
                        max_tokens: 1
                    };
                }
            },
            xai: {
                models: 'https://api.xai.com/v1/models',
                completions: 'https://api.xai.com/v1/chat/completions',
                payload: function(model) {
                    return {
                        model: model || 'grok-1',
                        messages: [{ role: 'user', content: 'Hello' }],
                        max_tokens: 1
                    };
                }
            },
            // openai_like 配置将在运行时动态设置
            openai_like: {
                models: '', // 由用户提供
                completions: '', // 将基于models URL构建
                payload: function(model) {
                    return {
                        model: model || '', // 由用户提供
                        messages: [{ role: 'user', content: 'Hello' }],
                        max_tokens: 1
                    };
                }
            }
        };
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 加载主题设置
            loadThemePreference();
            
            // 初始化结果区域为空状态
            initializeEmptyResults();
            
            // 切换API类型
            document.querySelectorAll('.api-type-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // 更新按钮状态
                    document.querySelectorAll('.api-type-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 更新当前API类型
                    currentApiType = this.dataset.apiType;
                    
                    // 更新设置显示
                    document.querySelectorAll('.api-settings').forEach(setting => setting.style.display = 'none');
                    document.getElementById(`${currentApiType}-settings`).style.display = 'block';
                    
                    // 尝试更新模型选择器
                    if (autoDetectModels) {
                        // 获取当前的API密钥
                        const keys = getApiKeys();
                        if (keys.length > 0) {
                            // 尝试检测当前API类型的可用模型
                            detectAvailableModels(keys, currentApiType);
                        }
                    }
                    
                    // 保存用户设置
                    saveUserSettings();
                });
            });
            
            // 切换输入方式
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabName = this.dataset.tab;
                    document.getElementById('text-input-container').style.display = tabName === 'text-input' ? 'block' : 'none';
                    document.getElementById('file-input-container').style.display = tabName === 'file-input' ? 'block' : 'none';
                });
            });
            
            // 文件选择更新显示文件名
            document.getElementById('file-input').addEventListener('change', function(e) {
                const fileName = e.target.files.length > 0 ? e.target.files[0].name : '未选择文件';
                document.getElementById('file-name').textContent = fileName;
            });
            
            // 验证按钮
            document.getElementById('validate-btn').addEventListener('click', startValidation);
            
            // 清除按钮
            document.getElementById('clear-btn').addEventListener('click', function() {
                document.getElementById('keys-input').value = '';
                document.getElementById('file-input').value = '';
                document.getElementById('file-name').textContent = '未选择文件';
                // document.getElementById('results-container').style.display = 'none'; // 移除这一行
                document.getElementById('progress-container').style.display = 'none';
                validationResults = [];
                
                // 重置为空结果状态
                initializeEmptyResults();
            });
            
            // 结果区域导出按钮
            document.getElementById('export-valid-results-btn').addEventListener('click', function() {
                exportResults('valid');
            });
            
            document.getElementById('export-all-results-btn').addEventListener('click', function() {
                exportResults('all');
            });
            
            // 客户端验证切换
            document.getElementById('client-side-toggle').addEventListener('change', function() {
                isClientSideValidation = this.checked;
            });
            
            // 暂停按钮
            document.getElementById('pause-btn').addEventListener('click', function() {
                if (isPaused) {
                    // 继续验证
                    isPaused = false;
                    this.textContent = '暂停';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-pause');
                    continueValidation();
                } else {
                    // 暂停验证
                    isPaused = true;
                    this.textContent = '继续';
                    this.classList.remove('btn-pause');
                    this.classList.add('btn-primary');
                }
            });
            
            // 取消按钮
            document.getElementById('cancel-btn').addEventListener('click', function() {
                cancelValidation();
            });
            
            // 暗色模式切换 - 完全重写以修复问题
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // 直接基于body类名切换模式，避免依赖isDarkMode变量
                    if (document.body.classList.contains('dark-mode')) {
                        // 当前是暗色模式，切换到亮色模式
                        document.body.classList.remove('dark-mode');
                        this.querySelector('.theme-toggle-icon').textContent = '🌙';
                        localStorage.setItem('theme', 'light');
                        isDarkMode = false;
                        console.log("已切换到亮色模式");
                    } else {
                        // 当前是亮色模式，切换到暗色模式
                        document.body.classList.add('dark-mode');
                        this.querySelector('.theme-toggle-icon').textContent = '☀️';
                        localStorage.setItem('theme', 'dark');
                        isDarkMode = true;
                        console.log("已切换到暗色模式");
                    }
                });
            }
            
            // 刷新节点信息
            document.getElementById('refresh-node-info').addEventListener('click', fetchNodeInfo);
            
            // 初始获取节点信息
            fetchNodeInfo();
            
            // 节点信息按钮点击事件
            document.getElementById('node-toggle').addEventListener('click', toggleNodeInfo);
            
            // 批量大小滑块事件
            const batchSizeSlider = document.getElementById('batch-size-slider');
            const batchSizeInput = document.getElementById('batch-size-input');
            
            // 滑块改变时更新输入框
            batchSizeSlider.addEventListener('input', function() {
                batchSize = parseInt(this.value);
                batchSizeInput.value = batchSize;
            });
            
            // 输入框改变时更新滑块
            batchSizeInput.addEventListener('change', function() {
                let value = parseInt(this.value);
                // 限制在合法范围内
                value = Math.max(1, Math.min(50, value));
                this.value = value;
                batchSize = value;
                batchSizeSlider.value = value;
            });
            
            // 并发切换
            const concurrencyToggle = document.getElementById('concurrency-toggle');
            const concurrencyControls = document.getElementById('concurrency-controls');
            const concurrencyInput = document.getElementById('concurrency-input');
            
            // 更新并发设置
            concurrencyToggle.addEventListener('change', function() {
                concurrencyEnabled = this.checked;
                concurrencyControls.style.display = concurrencyEnabled ? 'flex' : 'none';
            });
            
            concurrencyInput.addEventListener('change', function() {
                let value = parseInt(this.value);
                // 限制在合法范围内
                value = Math.max(1, Math.min(10, value));
                this.value = value;
                concurrencyCount = value;
            });
            
            // 自动检测模型切换
            document.getElementById('auto-detect-toggle').addEventListener('change', function() {
                autoDetectModels = this.checked;
            });
            
            
            // 修改各API类型模型选择器
            document.querySelectorAll('.model-select').forEach(select => {
                // 添加加载状态选项
                const loadingOption = document.createElement('option');
                loadingOption.value = 'loading';
                loadingOption.textContent = '正在加载可用模型...';
                loadingOption.disabled = true;
                loadingOption.style.display = 'none';
                select.appendChild(loadingOption);
                
                // 添加检测失败选项
                const failedOption = document.createElement('option');
                failedOption.value = 'failed';
                failedOption.textContent = '无法获取模型列表 (使用预设值)';
                failedOption.disabled = true;
                failedOption.style.display = 'none';
                select.appendChild(failedOption);
            });
            
            // 初始化节点信息显示状态
            concurrencyControls.style.display = concurrencyEnabled ? 'flex' : 'none';
            
            // 设置面板的折叠展开
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsContent = document.getElementById('settings-content');
            const settingsArrow = settingsToggle.querySelector('.settings-arrow');
            
            // 加载设置面板状态
            const settingsPanelExpanded = localStorage.getItem('settingsPanelExpanded') === 'true';
            
            if (settingsPanelExpanded) {
                settingsContent.classList.add('expanded');
                settingsArrow.style.transform = 'rotate(180deg)';
            }
            
            settingsToggle.addEventListener('click', function() {
                const isExpanded = settingsContent.classList.toggle('expanded');
                settingsArrow.style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
                localStorage.setItem('settingsPanelExpanded', isExpanded.toString());
            });
            
            // 设置说明按钮
            document.getElementById('settings-info-btn').addEventListener('click', function() {
                showBatchConcurrencyInfo();
            });
            
            // 加载用户之前的设置
            loadUserSettings();
            
            // 设置保存用户设置的事件监听器
            setupSettingsSaving();
            
            // 设置自定义API模型选择器逻辑
            const openaiLikeModelSelect = document.getElementById('openai_like-model');
            const customModelContainer = document.getElementById('custom-model-container');
            
            openaiLikeModelSelect.addEventListener('change', function() {
                // 如果选择的是自定义选项，显示输入框
                if (this.value === 'custom') {
                    customModelContainer.style.display = 'block';
                } else {
                    customModelContainer.style.display = 'none';
                }
            });
            
            // 初始化自定义模型输入框显示状态
            if (openaiLikeModelSelect.value === 'custom') {
                customModelContainer.style.display = 'block';
            } else {
                customModelContainer.style.display = 'none';
            }
            
            // 初始获取节点信息
            fetchNodeInfo();
        });
        
        // 初始化空结果状态
        function initializeEmptyResults() {
            // 更新统计数据显示为0
            document.getElementById('total-count').textContent = '0';
            document.getElementById('valid-count').textContent = '0';
            document.getElementById('invalid-count').textContent = '0';
            
            // 清空结果表格
            document.getElementById('results-body').innerHTML = '';
            
            // 显示空结果提示
            document.getElementById('results-empty').style.display = 'block';
            document.getElementById('results-table').style.display = 'none';
            
            // 禁用导出按钮
            document.getElementById('export-valid-results-btn').disabled = true;
            document.getElementById('export-all-results-btn').disabled = true;
        }
        
        // 加载主题偏好
        function loadThemePreference() {
            // 尝试从localStorage读取主题设置
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                enableDarkMode();
            }
        }
        
        // 切换暗色模式
        function toggleDarkMode() {
            console.log("切换暗色模式，当前状态:", isDarkMode);
            if (isDarkMode) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        }
        
        // 启用暗色模式
        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-toggle').querySelector('.theme-toggle-icon').textContent = '☀️';
            isDarkMode = true;
            localStorage.setItem('theme', 'dark');
        }
        
        // 禁用暗色模式
        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            document.getElementById('theme-toggle').querySelector('.theme-toggle-icon').textContent = '🌙';
            isDarkMode = false;
            localStorage.setItem('theme', 'light');
        }
        
        // 切换节点信息显示
        function toggleNodeInfo(event) {
            // 阻止事件冒泡
            event.stopPropagation();
            
            const nodeInfo = document.getElementById('node-info');
            if (nodeInfoVisible) {
                nodeInfo.classList.remove('visible');
                nodeInfoVisible = false;
            } else {
                nodeInfo.classList.add('visible');
                nodeInfoVisible = true;
                fetchNodeInfo(); // 获取最新节点信息
            }
        }
        
        // 点击其他区域隐藏节点信息
        document.addEventListener('click', function(event) {
            const nodeInfo = document.getElementById('node-info');
            const nodeToggle = document.getElementById('node-toggle');
            
            // 如果点击的不是节点信息区域和节点信息按钮，则隐藏节点信息
            if (nodeInfoVisible && 
                !nodeInfo.contains(event.target) && 
                !nodeToggle.contains(event.target)) {
                nodeInfo.classList.remove('visible');
                nodeInfoVisible = false;
            }
        });
        
        // 阻止节点信息区域内部点击事件冒泡
        document.getElementById('node-info').addEventListener('click', function(event) {
            event.stopPropagation();
        });
        
        // 获取节点信息
        async function fetchNodeInfo() {
            const nodeInfoContent = document.getElementById('node-info-content');
            nodeInfoContent.innerHTML = '<div class="node-info-loading">正在获取节点信息...</div>';
            
            try {
                // 获取IP信息
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const ip = ipData.ip;
                
                // 获取详细IP数据
                const geoResponse = await fetch(`https://ipapi.co/${ip}/json/`);
                const geoData = await geoResponse.json();
                
                // 计算固定的IP数据可信度分数 (基于IP和ASN等特征)
                // 使用IP和ASN等固定信息作为种子生成一个固定的分数，而不是每次都随机
                const ipComponents = ip.split('.').map(Number);
                let ipTrustScore = 70; // 基础分数
                
                // 基于IP特征调整分数
                if (geoData.asn) {
                    // 使用ASN作为固定信息源
                    const asnNumber = parseInt(geoData.asn.replace(/\D/g, '')) || 0;
                    // 使用ASN微调分数，但保持在0-100范围内
                    const asnFactor = (asnNumber % 30) - 15; // -15到15之间
                    ipTrustScore = Math.max(0, Math.min(100, ipTrustScore + asnFactor));
                }
                
                // 基于地理位置调整分数
                if (geoData.country_code) {
                    // 高可信区域
                    if (['US', 'CA', 'GB', 'AU', 'NZ', 'DE', 'FR', 'JP', 'KR', 'SG'].includes(geoData.country_code)) {
                        ipTrustScore += 15;
                    }
                    // 中等可信区域
                    else if (['BR', 'IN', 'ZA', 'MX', 'AR'].includes(geoData.country_code)) {
                        ipTrustScore += 0;
                    }
                    // 低可信区域
                    else if (['CN', 'RU', 'IR', 'KP', 'SY', 'CU'].includes(geoData.country_code)) {
                        ipTrustScore -= 15;
                    }
                }
                
                // 基于ISP调整分数
                if (geoData.org) {
                    const org = geoData.org.toLowerCase();
                    // 大型可信ISP
                    if (org.includes('amazon') || org.includes('google') || org.includes('microsoft') || 
                        org.includes('cloudflare') || org.includes('akamai')) {
                        ipTrustScore += 10;
                    }
                    // 可疑ISP关键词
                    if (org.includes('proxy') || org.includes('vpn') || org.includes('anon') || 
                        org.includes('hosting') || org.includes('data center')) {
                        ipTrustScore -= 10;
                    }
                }
                
                // 确保分数在0-100范围内
                ipTrustScore = Math.max(0, Math.min(100, ipTrustScore));
                
                // 设置分数颜色
                let ipScoreColor = ipTrustScore < 30 ? '#EF5350' : (ipTrustScore < 60 ? '#FFA726' : '#66BB6A');
                
                /* 不再使用ipdata API - 完全本地计算IP信任分数
                try {
                    // 注意：此处需要替换为您的ipdata API密钥
                    const ipDataApiKey = 'YOUR_IPDATA_API_KEY'; // 如果需要使用真实ipdata API，请替换此处
                    const ipDataResponse = await fetch(`https://api.ipdata.co/${ip}?api-key=${ipDataApiKey}`);
                    if (ipDataResponse.ok) {
                        const ipDataInfo = await ipDataResponse.json();
                        if (ipDataInfo.threat && typeof ipDataInfo.threat.is_threat === 'boolean') {
                            // 根据威胁分数计算信任分数 (0-100)
                            const threatScore = ipDataInfo.threat.is_threat ? 
                                (ipDataInfo.threat.threat_score || 0) : 0;
                            ipTrustScore = Math.max(0, 100 - threatScore);
                            ipScoreColor = ipTrustScore < 30 ? '#EF5350' : (ipTrustScore < 60 ? '#FFA726' : '#66BB6A');
                        }
                    }
                } catch (ipDataError) {
                    console.warn("无法获取ipdata威胁分数:", ipDataError);
                }
                */
                
                // 获取浏览器信息
                const browserInfo = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    vendor: navigator.vendor || 'Unknown',
                    cookiesEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack || 'Unknown',
                    connection: navigator.connection ? {
                        effectiveType: navigator.connection.effectiveType,
                        downlink: navigator.connection.downlink,
                        rtt: navigator.connection.rtt,
                        saveData: navigator.connection.saveData
                    } : 'Unavailable'
                };
                
                // 构建信息HTML
                let infoHTML = `
                    <div class="node-info-item">
                        <span class="node-info-label">IP:</span>
                        <span class="node-info-value">${ip}</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">地区:</span>
                        <span class="node-info-value">${geoData.country_name || 'Unknown'} (${geoData.country_code || 'N/A'})</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">城市:</span>
                        <span class="node-info-value">${geoData.city || 'Unknown'}, ${geoData.region || 'Unknown'}</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">ISP:</span>
                        <span class="node-info-value">${geoData.org || 'Unknown'}</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">时区:</span>
                        <span class="node-info-value">${geoData.timezone || 'Unknown'}</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">ASN:</span>
                        <span class="node-info-value">${geoData.asn || 'Unknown'}</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">IP类型:</span>
                        <span class="node-info-value">${getIpType(geoData)}</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">可信度分数:</span>
                        <span class="node-info-value" style="color: ${ipScoreColor}; font-weight: bold;">
                            ${ipTrustScore}/100 ${ipTrustScore < 30 ? '<span class="badge badge-warning">危险</span>' : ''}
                        </span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">节点类型:</span>
                        <span class="node-info-value">${getNodeType(geoData)}</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">浏览器:</span>
                        <span class="node-info-value">${getBrowserName(browserInfo.userAgent)}</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">操作系统:</span>
                        <span class="node-info-value">${getOSName(browserInfo.userAgent)}</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">语言:</span>
                        <span class="node-info-value">${browserInfo.language}</span>
                    </div>
                    <div class="node-info-item">
                        <span class="node-info-label">更新时间:</span>
                        <span class="node-info-value">${new Date().toLocaleString()}</span>
                    </div>
                `;
                
                nodeInfoContent.innerHTML = infoHTML;
            } catch (error) {
                nodeInfoContent.innerHTML = `
                    <div class="node-info-item">
                        <span class="node-info-label">错误:</span>
                        <span class="node-info-value">获取节点信息失败: ${error.message}</span>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="fetchNodeInfo()">重试</button>
                `;
            }
        }
        
        // 获取节点类型
        function getNodeType(geoData) {
            if (!geoData) return 'Unknown';
            
            // 检查是否为数据中心或云服务提供商
            if (geoData.org && (
                geoData.org.includes('Amazon') || 
                geoData.org.includes('AWS') || 
                geoData.org.includes('Microsoft') || 
                geoData.org.includes('Azure') || 
                geoData.org.includes('Google') || 
                geoData.org.includes('Cloudflare') ||
                geoData.org.includes('Digital Ocean') ||
                geoData.org.includes('Linode')
            )) {
                return '数据中心节点 <span class="badge badge-info">高速</span>';
            }
            
            // 检查是否为移动网络
            if (geoData.org && (
                geoData.org.includes('Mobile') || 
                geoData.org.includes('Wireless') || 
                geoData.org.includes('Cellular')
            )) {
                return '移动网络节点';
            }
            
            return '普通网络节点';
        }
        
        // 获取IP类型
        function getIpType(geoData) {
            if (!geoData) return 'Unknown';
            
            if (geoData.country_code === 'US') return 'United States IP';
            if (geoData.country_code === 'CN') return '中国 IP';
            
            return `${geoData.country_name || 'Unknown'} IP`;
        }
        
        // 取消验证
        function cancelValidation() {
            if (!isValidating) return;
            
            // 中止当前所有请求
            if (validationController) {
                validationController.abort();
            }
            
            isValidating = false;
            isPaused = false;
            activeBatches = 0;
            pendingQueue = [];
            
            // 重置UI
            document.getElementById('pause-btn').textContent = '暂停';
            document.getElementById('pause-btn').classList.remove('btn-primary');
            document.getElementById('pause-btn').classList.add('btn-pause');
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('validate-btn').disabled = false;
            
            // 如果已有部分结果，则显示
            if (validationResults.length > 0) {
                displayResults();
                document.getElementById('export-valid-results-btn').disabled = false;
                document.getElementById('export-all-results-btn').disabled = false;
            } else {
                // 没有结果，显示空状态
                initializeEmptyResults();
            }
        }
        
        // 解析输入获取API密钥
        function getApiKeys() {
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            
            if (activeTab === 'text-input') {
                const inputText = document.getElementById('keys-input').value.trim();
                if (!inputText) return [];
                
                // 分行并过滤空行
                return inputText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
            } else {
                const fileInput = document.getElementById('file-input');
                if (!fileInput.files || fileInput.files.length === 0) return [];
                
                // 文件处理在单独的函数中进行
                return []; // 暂时返回空数组，实际会在parseFile函数中异步处理
            }
        }
        
        // 获取当前选择的模型
        function getSelectedModel() {
            switch (currentApiType) {
                case 'openai':
                    return document.getElementById('openai-model').value;
                case 'claude':
                    return document.getElementById('claude-model').value;
                case 'gemini':
                    return document.getElementById('gemini-model').value;
                case 'deepseek':
                    return document.getElementById('deepseek-model').value;
                case 'xai':
                    return document.getElementById('xai-model').value;
                case 'openai_like':
                    return document.getElementById('custom-model-name').value.trim();
                default:
                    return null;
            }
        }
        
        // 获取自定义API配置
        function getCustomApiConfig() {
            if (currentApiType !== 'openai_like') return null;
            
            const customApiUrl = document.getElementById('custom-api-url').value.trim();
            let customModelName = '';
            
            // 获取模型名称 - 从选择器或输入框
            const modelSelect = document.getElementById('openai_like-model');
            if (modelSelect.value === 'custom') {
                // 如果选择的是自定义选项，则从输入框获取
                customModelName = document.getElementById('custom-model-name').value.trim();
            } else if (modelSelect.value !== 'loading' && modelSelect.value !== 'failed') {
                // 如果选择的是预设或自动检测的模型
                customModelName = modelSelect.value;
            } else {
                // 默认从输入框获取
                customModelName = document.getElementById('custom-model-name').value.trim();
            }
            
            if (!customApiUrl || !customModelName) {
                return null;
            }
            
            if (!customApiUrl.endsWith('/v1')) {
                alert('自定义API URL必须以 /v1 结尾');
                return null;
            }
            
            // 更新openai_like配置
            API_ENDPOINTS.openai_like.models = customApiUrl + '/models';
            API_ENDPOINTS.openai_like.completions = customApiUrl + '/chat/completions';
            
            return {
                custom_api_url: customApiUrl,
                custom_model_name: customModelName
            };
        }
        
        // 解析文件内容
        function parseFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const content = event.target.result;
                    let keys = [];
                    
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        // 解析CSV
                        const lines = content.split('\n');
                        keys = lines
                            .map(line => {
                                const columns = line.split(',');
                                return columns[0] ? columns[0].trim() : '';
                            })
                            .filter(key => key.length > 0);
                    } else {
                        // 解析文本文件
                        keys = content.split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0);
                    }
                    
                    resolve(keys);
                };
                
                reader.onerror = function() {
                    reject(new Error('文件读取失败'));
                };
                
                reader.readAsText(file);
            });
        }
        
        // 开始验证过程
        async function startValidation() {
            // 如果当前正在验证，则不执行
            if (isValidating && !isPaused) return;
            
            // 如果暂停状态，继续验证
            if (isValidating && isPaused) {
                continueValidation();
                return;
            }
            
            // 重置UI和状态
            document.getElementById('results-body').innerHTML = '';
            validationResults = [];
            document.getElementById('export-valid-results-btn').disabled = true;
            document.getElementById('export-all-results-btn').disabled = true;
            
            // 显示空结果状态
            document.getElementById('results-empty').style.display = 'block';
            document.getElementById('results-table').style.display = 'none';
            
            validationStats = {
                valid: 0,
                invalid: 0,
                error: 0
            };
            
            isValidating = true;
            isPaused = false;
            currentBatchIndex = 0;
            activeBatches = 0;
            pendingQueue = [];
            startTime = Date.now();
            
            // 禁用验证按钮
            document.getElementById('validate-btn').disabled = true;
            
            // 获取API密钥
            let keys = getApiKeys();
            
            // 根据API类型设置配置
            if (currentApiType === 'openai_like') {
                const customConfig = getCustomApiConfig();
                if (!customConfig) {
                    alert('请提供有效的自定义API URL和模型名称');
                    document.getElementById('validate-btn').disabled = false;
                    isValidating = false;
                    return;
                }
            }
            
            // 为Gemini设置带有选定模型的completions URL
            if (currentApiType === 'gemini') {
                const selectedModel = getSelectedModel();
                API_ENDPOINTS.gemini.completions = API_ENDPOINTS.gemini.completions.replace('MODEL_NAME', selectedModel);
            }
            
            // 如果是文件输入，处理文件
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            if (activeTab === 'file-input') {
                const fileInput = document.getElementById('file-input');
                if (!fileInput.files || fileInput.files.length === 0) {
                    alert('请选择一个文件');
                    document.getElementById('validate-btn').disabled = false;
                    isValidating = false;
                    return;
                }
                
                try {
                    keys = await parseFile(fileInput.files[0]);
                } catch (error) {
                    alert(`文件解析错误: ${error.message}`);
                    document.getElementById('validate-btn').disabled = false;
                    isValidating = false;
                    return;
                }
            }
            
            // 验证是否有密钥
            if (keys.length === 0) {
                alert('未找到API密钥');
                document.getElementById('validate-btn').disabled = false;
                isValidating = false;
                return;
            }
            
            // 检查重复项
            const { uniqueKeys, duplicateCount } = removeDuplicates(keys);
            keys = uniqueKeys;
            
            // 如果有重复项，提示用户
            if (duplicateCount > 0) {
                alert(`检测到${duplicateCount}个重复的API密钥，已自动移除。将使用${keys.length}个唯一密钥进行验证。`);
            }
            
            // 增加批量验证上限到5000个
            if (keys.length > 5000) {
                if (!confirm(`您正在尝试验证${keys.length}个密钥，这可能需要较长时间。是否继续？`)) {
                    document.getElementById('validate-btn').disabled = false;
                    isValidating = false;
                    return;
                }
            }
            
            // 准备验证队列
            validationQueue = [...keys];
            
            // 显示进度条
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressPercentage = document.getElementById('progress-percentage');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '准备验证...';
            progressPercentage.textContent = '0%';
            
            // 更新统计信息
            updateValidationStats(0, keys.length);
            
            // 选择验证方式
            if (isClientSideValidation) {
                // 创建新的AbortController用于取消验证
                validationController = new AbortController();
                
                // 启动验证处理 - 使用并发处理
                if (concurrencyEnabled) {
                    // 初始启动多个并发批次
                    const initialBatchCount = Math.min(concurrencyCount, Math.ceil(validationQueue.length / batchSize));
                    for (let i = 0; i < initialBatchCount; i++) {
                        processConcurrentBatch();
                    }
                } else {
                    // 顺序处理
                    processValidationBatch();
                }
            } else {
                await validateKeysServerSide(keys, updateProgress);
            }
        }
        
        // 移除重复密钥
        function removeDuplicates(keys) {
            const uniqueSet = new Set();
            const uniqueKeys = [];
            let duplicateCount = 0;
            
            keys.forEach(key => {
                if (!uniqueSet.has(key)) {
                    uniqueSet.add(key);
                    uniqueKeys.push(key);
                } else {
                    duplicateCount++;
                }
            });
            
            return { uniqueKeys, duplicateCount };
        }
        
        // 继续验证
        function continueValidation() {
            if (!isValidating || !isPaused) return;
            
            isPaused = false;
            processValidationBatch();
        }
        
        // 处理验证批次 (顺序执行版本)
        async function processValidationBatch() {
            if (!isValidating || isPaused) return;
            
            // 创建新的AbortController用于本批次请求
            validationController = new AbortController();
            
            const totalKeys = validationQueue.length;
            const processedCount = validationResults.length;
            
            // 如果所有批次已处理完毕
            if (currentBatchIndex >= validationQueue.length) {
                finishValidation();
                return;
            }
            
            // 获取当前批次
            const endIndex = Math.min(currentBatchIndex + batchSize, validationQueue.length);
            const currentBatch = validationQueue.slice(currentBatchIndex, endIndex);
            
            try {
                // 选择的模型
                const selectedModel = getSelectedModel();
                
                // 并行验证当前批次
                const batchPromises = currentBatch.map(key => 
                    validateSingleKeyClientSide(key, currentApiType, selectedModel, validationController.signal)
                );
                
                // 等待当前批次完成
                const batchResults = await Promise.all(batchPromises);
                
                // 更新结果
                validationResults.push(...batchResults);
                
                // 更新统计信息
                batchResults.forEach(result => {
                    if (result.valid) validationStats.valid++;
                    else if (result.error_code === 'NETWORK_ERROR') validationStats.error++;
                    else validationStats.invalid++;
                });
                
                // 更新进度
                const newProcessedCount = processedCount + currentBatch.length;
                const progress = (newProcessedCount / totalKeys) * 100;
                updateProgress(progress, `已验证 ${newProcessedCount}/${totalKeys}`);
                updateValidationStats(newProcessedCount, totalKeys);
                
                // 更新当前批次索引
                currentBatchIndex = endIndex;
                
                // 如果暂停，则不继续处理
                if (isPaused) return;
                
                // 批次间延迟，避免API限制
                if (currentBatchIndex < validationQueue.length) {
                    // 根据批次大小调整延迟时间：批次越大，延迟越长
                    const delay = Math.min(100 + (batchSize * 50), 2000); // 最小延迟500ms，最大延迟2000ms
                    setTimeout(processValidationBatch, delay);
                } else {
                    finishValidation();
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('验证被取消');
                } else {
                    console.error('批次处理错误:', error);
                    
                    // 如果出错但未被取消，尝试继续处理
                    if (isValidating && !isPaused) {
                        setTimeout(processValidationBatch, 2000); // 延迟更长时间后重试
                    }
                }
            }
        }
        
        // 处理并发验证批次 (并发执行版本)
        async function processConcurrentBatch() {
            if (!isValidating || isPaused) return;
            
            // 如果已经达到最大并发数，则不继续添加新任务
            if (activeBatches >= concurrencyCount) return;
            
            // 增加活跃批次计数
            activeBatches++;
            
            try {
                const totalKeys = validationQueue.length;
                
                // 如果所有批次已处理完毕
                if (currentBatchIndex >= validationQueue.length) {
                    // 减少活跃批次计数
                    activeBatches--;
                    
                    // 如果没有更多活跃批次，完成验证
                    if (activeBatches === 0 && pendingQueue.length === 0) {
                        finishValidation();
                    }
                    return;
                }
                
                // 获取当前批次
                const endIndex = Math.min(currentBatchIndex + batchSize, validationQueue.length);
                const currentBatch = validationQueue.slice(currentBatchIndex, endIndex);
                
                // 移动指针到下一批
                currentBatchIndex = endIndex;
                
                // 选择的模型
                const selectedModel = getSelectedModel();
                
                // 获取当前已处理的数量
                const processedCountBefore = validationResults.length;
                
                // 并行验证当前批次
                const batchPromises = currentBatch.map(key => 
                    validateSingleKeyClientSide(key, currentApiType, selectedModel, validationController.signal)
                );
                
                // 等待当前批次完成
                const batchResults = await Promise.all(batchPromises);
                
                // 确保我们仍在验证中（可能在等待过程中被取消）
                if (!isValidating) {
                    activeBatches--;
                    return;
                }
                
                // 更新结果
                validationResults.push(...batchResults);
                
                // 更新统计信息
                batchResults.forEach(result => {
                    if (result.valid) validationStats.valid++;
                    else if (result.error_code === 'NETWORK_ERROR') validationStats.error++;
                    else validationStats.invalid++;
                });
                
                // 更新进度
                const newProcessedCount = validationResults.length;
                const progress = (newProcessedCount / totalKeys) * 100;
                updateProgress(progress, `已验证 ${newProcessedCount}/${totalKeys}`);
                updateValidationStats(newProcessedCount, totalKeys);
                
                // 减少活跃批次计数
                activeBatches--;
                
                // 如果暂停，则不继续处理
                if (isPaused) return;
                
                // 如果还有更多要处理，延迟一下再启动下一个批次
                if (currentBatchIndex < validationQueue.length) {
                    // 根据批次大小调整延迟时间
                    const delay = Math.min(50 + (batchSize * 20), 1000); // 并发模式下使用更短的延迟
                    setTimeout(processConcurrentBatch, delay);
                } else if (activeBatches === 0) {
                    // 没有更多要处理，且所有活跃批次已完成
                    finishValidation();
                }
            } catch (error) {
                // 减少活跃批次计数
                activeBatches--;
                
                if (error.name === 'AbortError') {
                    console.log('并发验证被取消');
                } else {
                    console.error('并发批次处理错误:', error);
                    
                    // 如果出错但未被取消，继续处理下一批
                    if (isValidating && !isPaused && currentBatchIndex < validationQueue.length) {
                        setTimeout(processConcurrentBatch, 2000); // 延迟更长时间后重试
                    } else if (activeBatches === 0) {
                        // 如果没有更多活跃批次，且已经处理完所有批次
                        finishValidation();
                    }
                }
            }
            
            // 尝试启动更多批次，保持并发度
            if (isValidating && !isPaused && activeBatches < concurrencyCount && currentBatchIndex < validationQueue.length) {
                setTimeout(processConcurrentBatch, 100);
            }
        }
        
        // 完成验证
        function finishValidation() {
            isValidating = false;
            document.getElementById('validate-btn').disabled = false;
            
            // 确保进度条显示100%完成
            updateProgress(100, '验证完成');
            
            // 显示结果
            displayResults();
            
            // 启用导出按钮
            document.getElementById('export-valid-results-btn').disabled = false;
            document.getElementById('export-all-results-btn').disabled = false;
        }
        
        // 更新验证统计信息
        function updateValidationStats(processedCount, totalCount) {
            document.getElementById('validated-count').textContent = `已验证: ${processedCount}/${totalCount}`;
            document.getElementById('valid-progress').textContent = `有效: ${validationStats.valid}`;
            document.getElementById('invalid-progress').textContent = `无效: ${validationStats.invalid}`;
            document.getElementById('error-progress').textContent = `错误: ${validationStats.error}`;
            
            // 计算预计剩余时间
            if (processedCount > 0 && startTime) {
                const elapsedMs = Date.now() - startTime;
                const msPerKey = elapsedMs / processedCount;
                const remainingKeys = totalCount - processedCount;
                const remainingMs = remainingKeys * msPerKey;
                
                let timeRemainingText = '预计剩余时间: ';
                
                if (remainingMs < 60000) {
                    // 少于1分钟
                    timeRemainingText += `${Math.round(remainingMs / 1000)}秒`;
                } else if (remainingMs < 3600000) {
                    // 少于1小时
                    const minutes = Math.floor(remainingMs / 60000);
                    const seconds = Math.round((remainingMs % 60000) / 1000);
                    timeRemainingText += `${minutes}分${seconds}秒`;
                } else {
                    // 超过1小时
                    const hours = Math.floor(remainingMs / 3600000);
                    const minutes = Math.floor((remainingMs % 3600000) / 60000);
                    timeRemainingText += `${hours}小时${minutes}分钟`;
                }
                
                document.getElementById('time-remaining').textContent = timeRemainingText;
            } else {
                document.getElementById('time-remaining').textContent = '预计剩余时间: 计算中...';
            }
        }
        
        // 客户端验证密钥（浏览器端验证）
        async function validateKeysClientSide(keys, progressCallback) {
            validationResults = [];
            const totalKeys = keys.length;
            
            // 批量处理
            for (let i = 0; i < keys.length; i += batchSize) {
                if (isPaused) {
                    // 如果暂停，等待继续
                    await new Promise(resolve => {
                        const checkPaused = () => {
                            if (!isPaused) resolve();
                            else setTimeout(checkPaused, 500);
                        };
                        checkPaused();
                    });
                }
                
                if (!isValidating) break; // 如果取消了验证
                
                const batch = keys.slice(i, i + batchSize);
                const model = getSelectedModel();
                const batchPromises = batch.map(key => validateSingleKeyClientSide(key, currentApiType, model, validationController.signal));
                
                // 等待当前批次完成
                const batchResults = await Promise.all(batchPromises);
                validationResults.push(...batchResults);
                
                // 更新进度
                const completedCount = Math.min(i + batchSize, keys.length);
                const progress = (completedCount / totalKeys) * 100;
                progressCallback(progress, `已验证 ${completedCount}/${totalKeys}`);
                
                // 更新统计信息
                batchResults.forEach(result => {
                    if (result.valid) validationStats.valid++;
                    else if (result.error_code === 'NETWORK_ERROR') validationStats.error++;
                    else validationStats.invalid++;
                });
                
                updateValidationStats(completedCount, totalKeys);
                
                // 添加短暂延迟避免API限制
                if (i + batchSize < keys.length) {
                    // 根据批次大小调整延迟时间
                    const delay = Math.min(100 + (batchSize * 50), 2000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // 验证单个密钥（客户端）
        async function validateSingleKeyClientSide(key, apiType, modelName, signal) {
            const result = {
                key: key,
                valid: false,
                error_code: null,
                error_message: null
            };
            
            // 选择端点
            const config = API_ENDPOINTS[apiType];
            if (!config || !config.models) {
                result.error_code = "CONFIG_ERROR";
                result.error_message = "无效的API配置";
                return result;
            }
            
            const endpoint = config.models;
            let headers = {};
            
            // 设置不同API的头信息
            switch (apiType) {
                case 'openai':
                case 'openai_like':
                    headers = {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    };
                    break;
                case 'claude':
                    headers = {
                        'x-api-key': key,
                        'anthropic-version': '2023-06-01',
                        'Content-Type': 'application/json'
                    };
                    break;
                case 'gemini':
                    // Gemini使用查询参数而非头部
                    headers = {
                        'Content-Type': 'application/json'
                    };
                    break;
                case 'deepseek':
                    headers = {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    };
                    break;
                case 'xai':
                    headers = {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    };
                    break;
                default:
                    result.error_code = "UNSUPPORTED_API";
                    result.error_message = `不支持的API类型: ${apiType}`;
                    return result;
            }
            
            try {
                // 使用fetch进行API调用
                let url = endpoint;
                // 对于Gemini，将密钥作为URL参数
                if (apiType === 'gemini') {
                    url = `${endpoint}?key=${key}`;
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers,
                    // 使用传入的signal，并设置20秒超时
                    signal: signal ? signal : AbortSignal.timeout(20000) // 20秒超时
                });
                
                // 根据状态码确定有效性
                if (response.ok) {
                    result.valid = true;
                } else {
                    // 尝试读取错误信息
                    try {
                        const errorData = await response.json();
                        result.error_code = response.status.toString();
                        result.error_message = getErrorMessage(errorData, apiType);
                    } catch (e) {
                        result.error_code = response.status.toString();
                        result.error_message = `HTTP错误: ${response.status}`;
                    }
                }
            } catch (error) {
                // 如果主端点失败，尝试使用完成端点
                try {
                    const completionResult = await validateWithCompletionEndpoint(key, apiType, modelName, signal);
                    return completionResult;
                } catch (secondError) {
                    result.error_code = 'NETWORK_ERROR';
                    result.error_message = `网络错误: ${error.message || error.name || '未知错误'}`;
                }
            }
            
            return result;
        }
        
        // 使用完成端点进行验证（备用方法）
        async function validateWithCompletionEndpoint(key, apiType, modelName, signal) {
            const result = {
                key: key,
                valid: false,
                error_code: null,
                error_message: null
            };
            
            // 获取配置
            const config = API_ENDPOINTS[apiType];
            if (!config || !config.completions) {
                result.error_code = "CONFIG_ERROR";
                result.error_message = "无效的API配置";
                return result;
            }
            
            let headers = {};
            
            // 设置不同API的头信息
            switch (apiType) {
                case 'openai':
                case 'openai_like':
                case 'deepseek':
                case 'xai':
                    headers = {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    };
                    break;
                case 'claude':
                    headers = {
                        'x-api-key': key,
                        'anthropic-version': '2023-06-01',
                        'Content-Type': 'application/json'
                    };
                    break;
                case 'gemini':
                    headers = {
                        'Content-Type': 'application/json'
                    };
                    break;
                default:
                    result.error_code = "UNSUPPORTED_API";
                    result.error_message = `不支持的API类型: ${apiType}`;
                    return result;
            }
            
            try {
                // 使用fetch进行API调用
                let url = config.completions;
                if (apiType === 'gemini') {
                    url = `${url}?key=${key}`;
                }
                
                const payload = config.payload(modelName);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload),
                    // 使用传入的signal，并设置30秒超时
                    signal: signal ? signal : AbortSignal.timeout(30000) // 30秒超时
                });
                
                // 根据状态码确定有效性
                if (response.ok) {
                    result.valid = true;
                } else {
                    // 尝试读取错误信息
                    try {
                        const errorData = await response.json();
                        result.error_code = response.status.toString();
                        
                        // 特殊情况：401但消息指明无效API密钥
                        if (response.status === 401 || 
                            errorData.error?.message?.includes('key') || 
                            errorData.error?.includes('key') ||
                            errorData.error?.message?.includes('auth')) {
                            result.error_message = '无效的API密钥';
                        } else {
                            result.error_message = getErrorMessage(errorData, apiType);
                        }
                    } catch (e) {
                        result.error_code = response.status.toString();
                        result.error_message = `HTTP错误: ${response.status}`;
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw error; // 重新抛出中止错误，让上层处理
                }
                
                result.error_code = 'NETWORK_ERROR';
                result.error_message = `网络错误: ${error.message || error.name || '未知错误'}`;
            }
            
            return result;
        }
        
        // 从错误响应中提取消息
        function getErrorMessage(errorData, apiType) {
            switch (apiType) {
                case 'openai':
                case 'openai_like':
                case 'deepseek':
                case 'xai':
                    return errorData.error?.message || '未知错误';
                case 'claude':
                    return errorData.error?.message || errorData.detail || '未知错误';
                case 'gemini':
                    return errorData.error?.message || errorData.error || '未知错误';
                default:
                    return '未知错误';
            }
        }
        
        // 服务器端验证密钥
        async function validateKeysServerSide(keys, progressCallback) {
            try {
                const formData = new FormData();
                formData.append('input_method', 'text');
                formData.append('keys', keys.join('\n'));
                formData.append('api_type', currentApiType);
                formData.append('model', getSelectedModel());
                
                // 对于openai_like，添加自定义配置
                if (currentApiType === 'openai_like') {
                    const customConfig = getCustomApiConfig();
                    if (!customConfig) {
                        throw new Error('请提供有效的自定义API URL和模型名称');
                    }
                    
                    formData.append('custom_api_url', customConfig.custom_api_url);
                    formData.append('custom_model_name', customConfig.custom_model_name);
                }
                
                const response = await fetch('/validate', {
                    method: 'POST',
                    body: formData,
                    signal: validationController.signal
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '服务器验证失败');
                }
                
                const data = await response.json();
                validationResults = data.results;
                
                // 统计有效/无效数量
                validationStats.valid = validationResults.filter(r => r.valid).length;
                validationStats.invalid = validationResults.filter(r => !r.valid && r.error_code !== 'NETWORK_ERROR').length;
                validationStats.error = validationResults.filter(r => r.error_code === 'NETWORK_ERROR').length;
                
                // 完成进度
                progressCallback(100, '验证完成');
                updateValidationStats(keys.length, keys.length);
                
                // 完成验证
                finishValidation();
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('服务器验证被取消');
                } else {
                    alert(`验证失败: ${error.message}`);
                    document.getElementById('progress-container').style.display = 'none';
                    document.getElementById('validate-btn').disabled = false;
                    isValidating = false;
                }
            }
        }
        
        // 更新进度条
        function updateProgress(percentage, text) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressPercentage = document.getElementById('progress-percentage');
            
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = text;
            progressPercentage.textContent = `${Math.round(percentage)}%`;
        }
        
        // 显示验证结果
        function displayResults() {
            if (validationResults.length === 0) {
                initializeEmptyResults();
                return;
            }
            
            // 隐藏空结果提示，显示结果表格
            document.getElementById('results-empty').style.display = 'none';
            document.getElementById('results-table').style.display = 'table';
            
            // 统计数据
            const total = validationResults.length;
            const valid = validationResults.filter(r => r.valid).length;
            const invalid = total - valid;
            
            // 更新摘要
            document.getElementById('total-count').textContent = total;
            document.getElementById('valid-count').textContent = valid;
            document.getElementById('invalid-count').textContent = invalid;
            
            // 生成表格行
            const tableBody = document.getElementById('results-body');
            tableBody.innerHTML = '';
            
            validationResults.forEach(result => {
                const row = document.createElement('tr');
                
                // 密钥单元格（隐藏部分字符）
                const keyCell = document.createElement('td');
                keyCell.textContent = maskApiKey(result.key);
                row.appendChild(keyCell);
                
                // 状态单元格
                const statusCell = document.createElement('td');
                if (result.valid) {
                    statusCell.innerHTML = '<span class="valid-key">有效</span>';
                } else if (result.error_code === 'NETWORK_ERROR' || result.error_code === 'CONNECTION_ERROR' || result.error_code === 'TIMEOUT') {
                    statusCell.innerHTML = '<span class="network-error">网络错误</span>';
                } else {
                    statusCell.innerHTML = '<span class="invalid-key">无效</span>';
                }
                row.appendChild(statusCell);
                
                // 错误信息单元格
                const errorCell = document.createElement('td');
                errorCell.textContent = result.error_message || '-';
                row.appendChild(errorCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // 隐藏部分API密钥字符
        function maskApiKey(key) {
            if (!key || key.length < 8) return key;
            
            const firstFour = key.slice(0, 4);
            const lastFour = key.slice(-4);
            return `${firstFour}...${lastFour}`;
        }
        
        // 导出结果 (新版本支持两种导出模式)
        async function exportResults(exportType) {
            if (validationResults.length === 0) {
                alert('没有结果可导出');
                return;
            }
            
            try {
                // 通过API导出
                if (!isClientSideValidation) {
                    // 创建请求数据
                    const requestData = {
                        results: validationResults,
                        export_type: exportType, // 'all' 或 'valid'
                        api_type: currentApiType
                    };
                    
                    // 发送请求
                    const response = await fetch('/export', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '导出失败');
                    }
                    
                    // 获取文件名
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let fileName = `${currentApiType}_keys_validation_${exportType}.csv`;
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="?([^"]+)"?/);
                        if (match && match[1]) {
                            fileName = match[1];
                        }
                    }
                    
                    // 下载文件
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    link.click();
                    URL.revokeObjectURL(url);
                } else {
                    // 客户端生成并导出CSV
                    let csvContent = 'API密钥,状态,错误代码,错误信息\n';
                    
                    // 根据导出类型过滤结果
                    const resultsToExport = exportType === 'valid' 
                        ? validationResults.filter(r => r.valid)
                        : validationResults;
                    
                    resultsToExport.forEach(result => {
                        const status = result.valid ? '有效' : '无效';
                        const errorCode = result.error_code || '';
                        const errorMessage = result.error_message || '';
                        
                        // 正确处理CSV格式
                        const escapedKey = `"${result.key.replace(/"/g, '""')}"`;
                        const escapedMessage = `"${errorMessage.replace(/"/g, '""')}"`;
                        
                        csvContent += `${escapedKey},${status},${errorCode},${escapedMessage}\n`;
                    });
                    
                    // 创建并下载文件
                    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${currentApiType}_keys_validation_${exportType}_${getFormattedDate()}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                }
            } catch (error) {
                alert(`导出失败: ${error.message}`);
            }
        }
        
        // 获取格式化日期
        function getFormattedDate() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        // 获取浏览器名称
        function getBrowserName(userAgent) {
            if (userAgent.indexOf("Firefox") > -1) return "Firefox";
            if (userAgent.indexOf("Opera") > -1 || userAgent.indexOf("OPR") > -1) return "Opera";
            if (userAgent.indexOf("Trident") > -1) return "Internet Explorer";
            if (userAgent.indexOf("Edge") > -1) return "Edge";
            if (userAgent.indexOf("Chrome") > -1) return "Chrome";
            if (userAgent.indexOf("Safari") > -1) return "Safari";
            return "Unknown";
        }
        
        // 获取操作系统名称
        function getOSName(userAgent) {
            if (userAgent.indexOf("Win") > -1) return "Windows";
            if (userAgent.indexOf("Mac") > -1) return "MacOS";
            if (userAgent.indexOf("Linux") > -1) return "Linux";
            if (userAgent.indexOf("Android") > -1) return "Android";
            if (userAgent.indexOf("iOS") > -1 || userAgent.indexOf("iPhone") > -1 || userAgent.indexOf("iPad") > -1) return "iOS";
            return "Unknown";
        }
        
        // 显示批次和并发的详细说明
        function showBatchConcurrencyInfo() {
            alert(`【验证参数说明】

【批量大小】是指一次性发送多少个密钥请求:
• 小批量(1-10): 速度较慢但更稳定，适合网络不稳定情况
• 中等值(10-25): 平衡的速度和稳定性，适合大多数情况
• 大批量(25-50): 速度快但可能触发API限制

【并发验证】同时处理多个批次:
• 启用后可大幅提高验证速度
• 并发数建议3-5个，太多可能导致API限制
• 网络不稳定时建议关闭并发`);
        }
        
        // 保存用户设置
        function saveUserSettings() {
            const settings = {
                currentApiType: currentApiType,
                isClientSideValidation: isClientSideValidation,
                batchSize: batchSize,
                concurrencyEnabled: concurrencyEnabled,
                concurrencyCount: concurrencyCount,
                autoDetectModels: autoDetectModels
            };
            
            localStorage.setItem('userSettings', JSON.stringify(settings));
        }
        
        // 设置保存设置的事件监听器
        function setupSettingsSaving() {
            // 批量大小滑块
            document.getElementById('batch-size-slider').addEventListener('change', saveUserSettings);
            document.getElementById('batch-size-input').addEventListener('change', saveUserSettings);
            
            // 并发设置
            document.getElementById('concurrency-toggle').addEventListener('change', saveUserSettings);
            document.getElementById('concurrency-input').addEventListener('change', saveUserSettings);
            
            // 客户端验证
            document.getElementById('client-side-toggle').addEventListener('change', saveUserSettings);
            
            // 自动检测模型
            document.getElementById('auto-detect-toggle').addEventListener('change', saveUserSettings);
        }
        
        // 加载用户设置
        function loadUserSettings() {
            const settingsJson = localStorage.getItem('userSettings');
            if (!settingsJson) return;
            
            try {
                const settings = JSON.parse(settingsJson);
                
                // 加载API类型
                if (settings.currentApiType) {
                    currentApiType = settings.currentApiType;
                    
                    // 更新按钮状态
                    document.querySelectorAll('.api-type-btn').forEach(btn => {
                        if (btn.dataset.apiType === currentApiType) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    
                    // 更新设置显示
                    document.querySelectorAll('.api-settings').forEach(setting => {
                        setting.style.display = setting.id === `${currentApiType}-settings` ? 'block' : 'none';
                    });
                }
                
                // 加载客户端验证设置
                if (typeof settings.isClientSideValidation === 'boolean') {
                    isClientSideValidation = settings.isClientSideValidation;
                    document.getElementById('client-side-toggle').checked = isClientSideValidation;
                }
                
                // 加载批量大小设置
                if (settings.batchSize) {
                    batchSize = settings.batchSize;
                    document.getElementById('batch-size-slider').value = batchSize;
                    document.getElementById('batch-size-input').value = batchSize;
                }
                
                // 加载并发设置
                if (typeof settings.concurrencyEnabled === 'boolean') {
                    concurrencyEnabled = settings.concurrencyEnabled;
                    document.getElementById('concurrency-toggle').checked = concurrencyEnabled;
                    document.getElementById('concurrency-controls').style.display = concurrencyEnabled ? 'flex' : 'none';
                }
                
                if (settings.concurrencyCount) {
                    concurrencyCount = settings.concurrencyCount;
                    document.getElementById('concurrency-input').value = concurrencyCount;
                }
                
                // 加载自动检测模型设置
                if (typeof settings.autoDetectModels === 'boolean') {
                    autoDetectModels = settings.autoDetectModels;
                    document.getElementById('auto-detect-toggle').checked = autoDetectModels;
                }
            } catch (error) {
                console.error('加载用户设置失败:', error);
            }
        }
        
        // 查询可用的模型
        async function detectAvailableModels(keys, apiType) {
            if (!autoDetectModels || modelDetectionInProgress) return;
            
            // 检查是否有该API类型的模型选择器
            const modelSelect = document.getElementById(`${apiType}-model`);
            if (!modelSelect) return;
            
            // 将选择器置为"加载中"状态
            modelDetectionInProgress = true;
            const loadingOption = modelSelect.querySelector('option[value="loading"]');
            if (loadingOption) {
                loadingOption.style.display = 'block';
                modelSelect.value = 'loading';
            }
            
            try {
                // 只使用第一个密钥进行检测
                const key = keys[0];
                
                // 根据不同API类型设置请求参数
                let url, headers;
                
                switch (apiType) {
                    case 'openai':
                        url = 'https://api.openai.com/v1/models';
                        headers = { 'Authorization': `Bearer ${key}` };
                        break;
                    case 'claude':
                        url = 'https://api.anthropic.com/v1/models';
                        headers = { 
                            'x-api-key': key,
                            'anthropic-version': '2023-06-01'
                        };
                        break;
                    case 'gemini':
                        url = `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`;
                        headers = {};
                        break;
                    case 'deepseek':
                        url = 'https://api.deepseek.com/v1/models';
                        headers = { 'Authorization': `Bearer ${key}` };
                        break;
                    case 'xai':
                        url = 'https://api.xai.com/v1/models';
                        headers = { 'Authorization': `Bearer ${key}` };
                        break;
                    case 'openai_like':
                        const customConfig = getCustomApiConfig();
                        if (!customConfig) {
                            throw new Error('请提供有效的自定义API URL');
                        }
                        url = `${customConfig.custom_api_url}/models`;
                        headers = { 'Authorization': `Bearer ${key}` };
                        break;
                    default:
                        throw new Error(`不支持的API类型: ${apiType}`);
                }
                
                // 发送请求
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                let models = [];
                
                // 根据不同API类型解析返回数据
                switch (apiType) {
                    case 'openai':
                    case 'deepseek':
                    case 'xai':
                    case 'openai_like':
                        models = data.data
                            .filter(model => model.id)
                            .map(model => model.id);
                        break;
                    case 'claude':
                        models = data.models
                            .filter(model => model.id)
                            .map(model => model.id);
                        break;
                    case 'gemini':
                        models = data.models
                            .filter(model => model.name)
                            .map(model => {
                                // 从全名中提取模型名称
                                const nameParts = model.name.split('/');
                                return nameParts[nameParts.length - 1];
                            });
                        break;
                }
                
                // 更新模型选择器
                if (models.length > 0) {
                    // 保存当前选中的值
                    const currentValue = modelSelect.value;
                    
                    // 清除除了特殊选项外的所有选项
                    const options = Array.from(modelSelect.options);
                    options.forEach(option => {
                        if (!['loading', 'failed'].includes(option.value)) {
                            modelSelect.removeChild(option);
                        }
                    });
                    
                    // 添加检测到的模型选项
                    models.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        
                        // 将模型选项插入到特殊选项之前
                        const loadingOption = modelSelect.querySelector('option[value="loading"]');
                        modelSelect.insertBefore(option, loadingOption);
                    });
                    
                    // 尝试恢复之前选中的值，如果不存在则选择第一个
                    if (models.includes(currentValue) && currentValue !== 'loading' && currentValue !== 'failed') {
                        modelSelect.value = currentValue;
                    } else {
                        modelSelect.value = models[0];
                    }
                    
                    // 存储可用模型列表
                    availableModels[apiType] = models;
                } else {
                    throw new Error('未检测到任何可用模型');
                }
            } catch (error) {
                console.error(`检测${apiType}模型失败:`, error);
                
                // 显示失败选项
                const failedOption = modelSelect.querySelector('option[value="failed"]');
                if (failedOption) {
                    failedOption.style.display = 'block';
                    modelSelect.value = 'failed';
                }
            } finally {
                // 隐藏加载选项
                const loadingOption = modelSelect.querySelector('option[value="loading"]');
                if (loadingOption) {
                    loadingOption.style.display = 'none';
                }
                
                modelDetectionInProgress = false;
            }
        }
    </script>
</body>
</html>